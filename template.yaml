# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

# The AWSTemplateFormatVersion identifies the capabilities of the template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/format-version-structure.html
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  jmap-server

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform:
- AWS::Serverless-2016-10-31

# Parameters section
Parameters:
  RootDomainName:
    Type: String
    Description: Root domain name for the JMAP API (e.g., jmapbox.com)
  SubDomainName:
    Type: String
    Description: Subdomain the api is on
    Default: "api"
  AdminUsername:
    Type: String
    Description: Admin username (without domain, will be used as username@RootDomainName)
    Default: admin
  AllowedClientOrigins:
    Type: CommaDelimitedList
    Description: "Comma-separated allowed CORS origins (e.g., https://jmapbox.com,https://second.com,http://localhost:5173)"
    Default: "http://localhost:5173"

# Globals section for shared function and API Gateway configuration
Globals:
  Function:
    Runtime: nodejs22.x
    Architectures:
      - arm64
    Timeout: 30
    Environment:
      Variables:
        ALLOWED_ORIGINS: !Join [',', !Ref AllowedClientOrigins]

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:
  # HTTP API (no API Gateway authorizer; handlers enforce Basic/Bearer)
  JmapHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      DefaultRouteSettings:
        ThrottlingBurstLimit: 1000
        ThrottlingRateLimit: 500
      CorsConfiguration:
        AllowMethods:
          - GET
          - POST
          - OPTIONS
        AllowHeaders:
          - Authorization
          - Content-Type
          - Cookie
          - X-Requested-With
        AllowOrigins: !Ref AllowedClientOrigins
        AllowCredentials: true

  # Cognito User Pool Client (required for API Gateway integration)
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: jmap-server-client
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH

  # Admin user for the User Pool
  AdminUser:
    Type: AWS::Cognito::UserPoolUser
    DependsOn: UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      Username: !Sub '${AdminUsername}@${RootDomainName}'
      MessageAction: SUPPRESS
      UserAttributes:
        - Name: email
          Value: !Sub '${AdminUsername}@${RootDomainName}'
        - Name: email_verified
          Value: 'true'
      DesiredDeliveryMediums: []
      ForceAliasCreation: false

  # JMAP ENDPOINTS
  jmapSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/jmap/session.sessionHandler
      Environment:
        Variables:
          API_URL: !Sub 'https://${SubDomainName}.${RootDomainName}/jmap'
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /jmap/session
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/jmap/session.ts

  jmapApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/jmap/api.apiHandler
      Environment:
        Variables:
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /jmap/api
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/jmap/api.ts

  jmapUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/jmap/upload.uploadHandler
      Environment:
        Variables:
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /upload/{accountId}
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/jmap/upload.ts

  jmapDownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/jmap/download.downloadHandler
      Environment:
        Variables:
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /jmap/download/{accountId}/{blobId}/{name}
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/jmap/download.ts

  # END OF JMAP API ENDPOINTS

  # AUTH API ENDPOINTS

  authLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/logout.handler
      Environment:
        Variables:
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /auth/logout
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/logout.ts

  authLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/login.handler
      Environment:
        Variables:
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /auth/login
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/login.ts

  authTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/token.handler
      Environment:
        Variables:
          USER_POOL_CLIENT_ID: !Ref UserPoolClient
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref JmapHttpApi
            Path: /auth/token
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/token.ts

  # END OF AUTH API ENDPOINTS

  # User pool for auth (cognito)
  UserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Retain
    Properties:
      UserPoolName: jmap-server-UserPool
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true

      UsernameAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: false



Outputs:
  HttpApiUrl:
    Description: "HTTP API base URL"
    Value: !Sub "https://${JmapHttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}"
  HttpApiId:
    Description: "HTTP API ID"
    Value: !Ref JmapHttpApi
  UserPoolId:
    Description: "Cognito User Pool ID"
    Value: !Ref UserPool
  UserPoolClientId:
    Description: "Cognito User Pool Client ID"
    Value: !Ref UserPoolClient
