# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

# The AWSTemplateFormatVersion identifies the capabilities of the template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/format-version-structure.html
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Serverless TypeScript Lambda API built on AWS

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform:
- AWS::Serverless-2016-10-31

# Parameters section
Parameters:
  RootDomainName:
    Type: String
    Description: Root domain name for the API (e.g., example.com)
  SubDomainName:
    Type: String
    Description: Subdomain the api is on
    Default: "api"
  AdminUsername:
    Type: String
    Description: Admin username (without domain, will be used as username@RootDomainName)
    Default: admin
  AllowedClientOrigins:
    Type: CommaDelimitedList
    Description: "Comma-separated allowed CORS origins (e.g., https://example.com,https://second.com,http://localhost:5173)"
    Default: "http://localhost:5173"
  VertexAiApiKey:
    Type: String
    Description: "Vertex AI API Key"
    NoEcho: true
  GoogleVertexProject:
    Type: String
    Description: "Google Vertex Project ID"
  GoogleVertexLocation:
    Type: String
    Description: "Google Vertex Location"
    Default: "us-central1"
  GoogleCredentialsJson:
    Type: String
    Description: "Google Service Account credentials JSON (for Lambda)"
    NoEcho: true
    Default: ""
  ApifyApiToken:
    Type: String
    Description: "Apify API Token for LinkedIn scraping"
    NoEcho: true

# Globals section for shared function and API Gateway configuration
Globals:
  Function:
    Runtime: nodejs22.x
    Architectures:
      - arm64
    Timeout: 180
    Environment:
      Variables:
        ALLOWED_ORIGINS: !Join [',', !Ref AllowedClientOrigins]
        BASE_URL: !Sub 'https://${SubDomainName}.${RootDomainName}'
        USER_POOL_CLIENT_ID: !Ref UserPoolClient
        USER_POOL_ID: !Ref UserPool
        VERTEX_AI_API_KEY: !Ref VertexAiApiKey
        GOOGLE_VERTEX_PROJECT: !Ref GoogleVertexProject
        GOOGLE_VERTEX_LOCATION: !Ref GoogleVertexLocation
        APIFY_API_TOKEN: !Ref ApifyApiToken
        NODE_OPTIONS: "--enable-source-maps"

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:
  # HTTP API (no API Gateway authorizer; handlers enforce Basic/Bearer)
  LambdaHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      DefaultRouteSettings:
        ThrottlingBurstLimit: 1000
        ThrottlingRateLimit: 500
      CorsConfiguration:
        AllowMethods:
          - GET
          - POST
          - OPTIONS
        AllowHeaders:
          - Authorization
          - Content-Type
          - Cookie
          - X-Requested-With
        AllowOrigins: !Ref AllowedClientOrigins
        AllowCredentials: true

  # Cognito User Pool Client (required for API Gateway integration)
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: lambda-api-client
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH

  # Admin user for the User Pool
  AdminUser:
    Type: AWS::Cognito::UserPoolUser
    DependsOn: UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      Username: !Sub '${AdminUsername}@${RootDomainName}'
      MessageAction: SUPPRESS
      UserAttributes:
        - Name: email
          Value: !Sub '${AdminUsername}@${RootDomainName}'
        - Name: email_verified
          Value: 'true'
      DesiredDeliveryMediums: []
      ForceAliasCreation: false

  # API ENDPOINTS
  apiAuthedFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/authed.authedHandler
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /api/authed
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/authed.ts



  # AUTH ENDPOINTS

  authLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/logout.handler
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /auth/logout
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/logout.ts

  authLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/login.handler
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /auth/login
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/login.ts

  authTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/auth/token.handler
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /auth/token
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/auth/token.ts

  # END OF AUTH API ENDPOINTS

  # ERROR PAGES

  errorPagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/errors/index.errorHandler
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /errors/{errorCode}
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        Loader:
          - .html=text
        EntryPoints:
          - src/handlers/errors/index.ts

  # END OF ERROR PAGES

  # User pool for auth (cognito)
  UserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Retain
    Properties:
      UserPoolName: lambda-api-UserPool
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true

      UsernameAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: false

  GenerationJobsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: jobId
          AttributeType: S
      KeySchema:
        - AttributeName: jobId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  MastraStore:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: gsi1pk
          AttributeType: S
        - AttributeName: gsi1sk
          AttributeType: S
        - AttributeName: gsi2pk
          AttributeType: S
        - AttributeName: gsi2sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: gsi1
          KeySchema:
            - AttributeName: gsi1pk
              KeyType: HASH
            - AttributeName: gsi1sk
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: gsi2
          KeySchema:
            - AttributeName: gsi2pk
              KeyType: HASH
            - AttributeName: gsi2sk
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  GenerationDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600  # 14 days

  GenerationQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      MessageRetentionPeriod: 86400
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt GenerationDeadLetterQueue.Arn
        maxReceiveCount: 3

  apiGenerateStartFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/api/generate-start.generateStartHandler
      Environment:
        Variables:
          GENERATION_JOBS_TABLE: !Ref GenerationJobsTable
          GENERATION_QUEUE_URL: !Ref GenerationQueue
          DDB_ENDPOINT: ""
          SQS_ENDPOINT: ""
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /api/generate/start
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GenerationJobsTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt GenerationQueue.QueueName
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/api/generate-start.ts

  apiGenerateStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/api/generate-status.generateStatusHandler
      Environment:
        Variables:
          GENERATION_JOBS_TABLE: !Ref GenerationJobsTable
          DDB_ENDPOINT: ""
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /api/generate/status/{jobId}
            Method: GET
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref GenerationJobsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/api/generate-status.ts

  apiGenerateChoicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/api/generate-choices.generateChoicesHandler
      Environment:
        Variables:
          GENERATION_JOBS_TABLE: !Ref GenerationJobsTable
          GENERATION_QUEUE_URL: !Ref GenerationQueue
          DDB_ENDPOINT: ""
          SQS_ENDPOINT: ""
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref LambdaHttpApi
            Path: /api/generate/choices/{jobId}
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GenerationJobsTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt GenerationQueue.QueueName
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/api/generate-choices.ts



  apiGenerateWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/queue/generate-worker.generateWorkerHandler
      MemorySize: 1024  # Increased from default 128MB to handle AI workloads
      Timeout: 300  # Increased to 5 minutes to match queue visibility timeout
      Environment:
        Variables:
          GENERATION_JOBS_TABLE: !Ref GenerationJobsTable
          MASTRA_TABLE_NAME: !Ref MastraStore

          GOOGLE_CREDENTIALS_JSON: !Ref GoogleCredentialsJson
          DDB_ENDPOINT: ""
          SQS_ENDPOINT: ""
          GENERATION_QUEUE_URL: !Ref GenerationQueue
      Events:
        QueueEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt GenerationQueue.Arn
            BatchSize: 1  # Process one message at a time to avoid memory issues
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GenerationJobsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MastraStore
        - SQSPollerPolicy:
            QueueName: !GetAtt GenerationQueue.QueueName
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/handlers/queue/generate-worker.ts



Outputs:
  HttpApiId:
    Description: "HTTP API ID"
    Value: !Ref LambdaHttpApi
  UserPoolId:
    Description: "Cognito User Pool ID"
    Value: !Ref UserPool
  UserPoolClientId:
    Description: "Cognito User Pool Client ID"
    Value: !Ref UserPoolClient
